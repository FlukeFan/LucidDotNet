<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>

    <Version>0.0.1</Version>

    <PreserveCompilationContext Condition="$(IsTestProject)=='true'">true</PreserveCompilationContext>
    <CoverageTarget Condition="'$(CoverageTarget)'==''">90</CoverageTarget>
    <NoCoverage Condition="'$(NoCoverage)'==''">false</NoCoverage>

    <BuildUtil>$(MSBuildThisFileDirectory)\BuildUtil\bin\Debug\netcoreapp2.1\Build.BuildUtil.dll</BuildUtil>
    <AltCover>$(NuGetPackageRoot)altcover\4.0.655\tools\netcoreapp2.0\AltCover.dll</AltCover>
    <VsTestConsole>$(MSBuildExtensionsPath)vstest.console.dll</VsTestConsole>
    <ReportGenerator>$(NuGetPackageRoot)reportgenerator\4.0.3\tools\netcoreapp2.0\ReportGenerator.dll</ReportGenerator>

    <TestAssembly>$(AssemblyName).dll</TestAssembly>
    <TestSuccessFlag>$(AssemblyName).noCoverage$(NoCoverage).success.flg</TestSuccessFlag>
    <CoverageOutput>$(AssemblyName).coverage.xml</CoverageOutput>

  </PropertyGroup>

  <ItemGroup>
    <TestDependencies Include="$(OutDir)\$(AssemblyName).dll" />
    <TestDependencies Include="../**/*.cshtml" />
  </ItemGroup>

  <ItemGroup>
    <CoverageAssemblyFilter Include="NUnit3.TestAdapter" />
    <CoverageAssemblyFilter Include="Lucid.Infrastructure.Lib" />
  </ItemGroup>

  <Target Name="BeforeBuildComplete" AfterTargets="AfterBuild">
    <CallTarget Targets="RunTests" Condition="$(IsTestProject)=='true'" />
  </Target>

  <Target Name="RunTests" Condition="'$(RunTests)'=='true' or '$(FilterTestFqn)'!=''" Inputs="@(TestDependencies)" Outputs="$(OutDir)$(TestSuccessFlag)">
    <CallTarget Targets="RunTestsWithFilter" Condition="'$(FilterTestFqn)'!=''" />
    <CallTarget Targets="RunTestsWithoutCoverage" Condition="'$(FilterTestFqn)'=='' And '$(NoCoverage)'=='true'" />
    <CallTarget Targets="RunTestsWithCoverage" Condition="'$(FilterTestFqn)'=='' And '$(NoCoverage)'!='true'" />
  </Target>

  <Target Name="RunTestsWithFilter">
    <Message Importance="high" Text="Running VsTestConsole with --testcasefilter:FullyQualifiedName~$(FilterTestFqn)" />
    <Exec Command="dotnet &quot;$(VsTestConsole)&quot; $(TestAssembly) --logger:trx --testcasefilter:FullyQualifiedName~$(FilterTestFqn)" WorkingDirectory="$(OutDir)" />
  </Target>

  <Target Name="RunTestsWithoutCoverage">
    <PropertyGroup>
      <TestStartTime>$([System.DateTime]::Now.AddSeconds(1).ToString(yyyy-MM-dd HH:mm:ss))</TestStartTime>
    </PropertyGroup>
    <Message Importance="high" Text="Running tests: $(TestAssembly)" />
    <Exec WorkingDirectory="$(OutDir)" Command="dotnet.exe &quot;$(VsTestConsole)&quot; $(TestAssembly) --logger:trx" />
    <Touch Files="$(OutDir)$(TestSuccessFlag)" Time="$(TestStartTime)" AlwaysCreate="true" />
  </Target>

  <Target Name="RunTestsWithCoverage">
    <PropertyGroup>
      <TestStartTime>$([System.DateTime]::Now.AddSeconds(1).ToString(yyyy-MM-dd HH:mm:ss))</TestStartTime>
    </PropertyGroup>
    <Message Importance="high" Text="Running tests: $(TestAssembly)" />
    <Exec WorkingDirectory="$(OutDir)" Command="dotnet $(AltCover) --opencover --save --outputDirectory __Instrumented --xmlReport $(CoverageOutput) --assemblyFilter &quot;@(CoverageAssemblyFilter)&quot; --typeFilter &quot;@(CoverageTypeFilter)&quot; --methodFilter &quot;@(CoverageMethodFilter)&quot; --attributeFilter &quot;@(CoverageAttributeFilter)&quot;" />
    <Exec WorkingDirectory="$(OutDir)\__Instrumented" Command="dotnet.exe &quot;$(VsTestConsole)&quot; $(TestAssembly) --logger:trx" />
    <Exec WorkingDirectory="$(OutDir)" Command="dotnet $(AltCover) Runner --collect -r __Instrumented" />
    <RemoveDir Directories="$(OutDir)CoverageReport" />
    <Exec WorkingDirectory="$(OutDir)" Command="dotnet $(ReportGenerator) -reports:$(CoverageOutput) -targetdir:CoverageReport -verbosity:Error -ReportTypes:Html;XmlSummary" />
    <Exec Command="dotnet &quot;$(BuildUtil)&quot; VerifyCoverage $(CoverageTarget) $(OutDir)CoverageReport/Summary.xml" />
    <Touch Files="$(OutDir)$(TestSuccessFlag)" Time="$(TestStartTime)" AlwaysCreate="true" />
  </Target>

  <Target Name="CopyPackageContents" Condition="'$(CopyPackageContent)' == 'true'" BeforeTargets="Compile">
    <Exec Command="dotnet &quot;$(BuildUtil)&quot; CopyPackageContents &quot;$(MSBuildProjectFullPath)&quot; $(NuGetPackageRoot)" />
  </Target>

</Project>